<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Pipeline Demo</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 14px;
      background: #0f1117;
      color: #e2e8f0;
      line-height: 1.6;
    }
    a { color: #63b3ed; text-decoration: none; }
    a:hover { text-decoration: underline; }

    header {
      background: #141720;
      border-bottom: 1px solid #2d3748;
      padding: 18px 32px;
      display: flex;
      align-items: baseline;
      gap: 16px;
    }
    header h1 { margin: 0; font-size: 20px; color: #90cdf4; }
    header p  { margin: 0; font-size: 13px; color: #718096; }

    .section-heading {
      max-width: 1400px;
      margin: 28px auto 0;
      padding: 0 32px;
      display: flex;
      align-items: baseline;
      gap: 12px;
    }
    .section-heading h2 {
      margin: 0;
      font-size: 17px;
      color: #90cdf4;
      font-weight: 600;
    }
    .section-heading .count {
      font-size: 12px;
      color: #4a5568;
    }

    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 20px;
      padding: 12px 32px 28px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: #141720;
      border: 1px solid #2d3748;
      border-radius: 10px;
      overflow: hidden;
      transition: border-color .2s, transform .15s;
      cursor: pointer;
    }
    .card:hover {
      border-color: #4299e1;
      transform: translateY(-2px);
    }
    .card-thumb {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: cover;
      display: block;
      background: #1a1f2e;
    }
    .card-thumb.placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: #2d3748;
    }
    .card-body { padding: 12px 14px 14px; }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: #e2e8f0;
      margin: 0 0 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-collection {
      font-size: 11px;
      color: #718096;
      margin: 0 0 8px;
    }
    .card-page-count {
      font-size: 11px;
      color: #718096;
      margin: 0 0 6px;
    }
    .card-provenance {
      font-size: 10px;
      color: #4a5568;
      margin: 0 0 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-provenance a {
      color: #4a5568;
    }
    .card-provenance a:hover {
      color: #63b3ed;
    }
    .pipeline-steps {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0;
      row-gap: 6px;
      margin-top: 4px;
    }
    .pipeline-step {
      display: flex;
      align-items: center;
    }
    .step-label {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 3px;
      background: #2d3748;
      color: #a0aec0;
      white-space: nowrap;
    }
    .step-label.done    { background: #1c4532; color: #9ae6b4; border: 1px solid #276749; }
    .step-label.failed  { background: #3b1515; color: #fed7d7; border: 1px solid #742a2a; }
    .step-arrow {
      font-size: 18px;
      font-weight: 700;
      line-height: 1;
      color: #718096;
      padding: 0 1px;
      user-select: none;
    }
    .step-arrow.done { color: #48bb78; }

    .status-bar {
      font-size: 11px;
      padding: 4px 14px 10px;
      color: #718096;
    }
    .status-bar.complete { color: #9ae6b4; }
    .status-bar.pending  { color: #fbd38d; }

    .empty-section {
      color: #4a5568;
      padding: 20px 32px;
      max-width: 1400px;
      margin: 0 auto;
      font-style: italic;
    }

    #loading {
      text-align: center;
      padding: 80px 32px;
      color: #4a5568;
    }
    #error {
      display: none;
      margin: 32px;
      padding: 16px 20px;
      background: #742a2a22;
      border: 1px solid #742a2a;
      border-radius: 8px;
      color: #fed7d7;
    }
  </style>
</head>
<body>

<header>
  <h1>AI Pipeline Demo</h1>
  <p>Powered by <a href="https://packagist.org/packages/survos/ai-pipeline-bundle">survos/ai-pipeline-bundle</a></p>
</header>

<div id="loading">Loading manifests...</div>
<div id="error"></div>
<div id="content" style="display:none"></div>

<script type="module">
function esc(s) {
  return String(s ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function isImageUrl(url) {
  return /\.(jpe?g|png|gif|webp|avif)(\?.*)?$/i.test(url) || url.includes('/iiif/');
}

function thumbUrl(url) {
  if (url.includes('/iiif/2/')) {
    return url.replace(/\/full\/[^/]+\/0\/default\.jpg/, '/full/,300/0/default.jpg');
  }
  return url;
}

function displayUrl(url) {
  if (url.startsWith('http://') || url.startsWith('https://')) return thumbUrl(url);
  return url;
}

async function sha1hex(str) {
  const buf  = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-1', buf);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/** For PDFs, use the result_file hash (which is sha1 of url) as the page prefix */
function pdfThumbFromResultFile(resultFile) {
  if (!resultFile) return null;
  // result_file is like "ce9e060336acc7313261152034bad5b17fc29186.json"
  const sha1 = resultFile.replace(/\.json$/, '');
  return `images/pages/${sha1}-01.jpg`;
}

async function loadManifest(path) {
  try {
    const resp = await fetch(path);
    if (!resp.ok) return [];
    return await resp.json();
  } catch (_) {
    return [];
  }
}

function makeCard(entry, results, type) {
  const url        = entry.url ?? '';
  const title      = entry.title ?? url;
  const collection = entry.collection ?? '';
  const provenance = entry.provenance ?? '';
  const pipeline   = entry.pipeline ?? [];
  const status     = entry.status ?? 'pending';
  const resultFile = entry.result_file ?? null;

  const viewerUrl = resultFile
    ? `item.html?url=${encodeURIComponent(url)}&data=data&type=${type}`
    : null;

  let thumb;
  if (type === 'pdf') {
    const src = pdfThumbFromResultFile(resultFile);
    thumb = src
      ? `<img class="card-thumb" src="${esc(src)}" alt="${esc(title)}" loading="lazy"
              onerror="this.outerHTML='<div class=\\'card-thumb placeholder\\'>PDF</div>'" />`
      : `<div class="card-thumb placeholder">PDF</div>`;
  } else if (isImageUrl(url)) {
    thumb = `<img class="card-thumb" src="${esc(displayUrl(url))}" alt="${esc(title)}" loading="lazy" />`;
  } else {
    thumb = `<div class="card-thumb placeholder">?</div>`;
  }

  const steps = pipeline.map((t, i) => {
    const r = results?.[t];
    const cls = !r ? '' : r.error ? 'failed' : 'done';
    const arrow = i < pipeline.length - 1
      ? `<span class="step-arrow ${cls}">&rarr;</span>`
      : '';
    return `<span class="pipeline-step"><span class="step-label ${cls}">${esc(t)}</span>${arrow}</span>`;
  }).join('');

  const statusLabel = status === 'complete'
    ? `<div class="status-bar complete">Pipeline complete</div>`
    : `<div class="status-bar pending">Not yet processed</div>`;

  // Show page count for PDFs if available
  const pageCount = entry.inputs?.max_pages;
  const pageInfo = (type === 'pdf' && pageCount)
    ? `<div class="card-page-count">${pageCount} pages</div>`
    : '';

  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    ${thumb}
    <div class="card-body">
      <div class="card-title" title="${esc(title)}">${esc(title)}</div>
      ${collection ? `<div class="card-collection">${esc(collection)}</div>` : ''}
      ${provenance ? `<div class="card-provenance"><a href="${esc(provenance)}" target="_blank" title="Source" onclick="event.stopPropagation()">${esc(new URL(provenance).hostname)}</a></div>` : ''}
      ${pageInfo}
      <div class="pipeline-steps">${steps}</div>
    </div>
    ${statusLabel}
  `;

  if (viewerUrl) {
    card.addEventListener('click', () => { window.location.href = viewerUrl; });
  }

  return card;
}

async function renderSection(contentEl, label, icon, entries, type) {
  if (!entries.length) return;

  const heading = document.createElement('div');
  heading.className = 'section-heading';
  heading.innerHTML = `<h2>${icon} ${esc(label)}</h2><span class="count">${entries.length} item${entries.length !== 1 ? 's' : ''}</span>`;
  contentEl.appendChild(heading);

  const gallery = document.createElement('div');
  gallery.className = 'gallery';
  contentEl.appendChild(gallery);

  for (const entry of entries) {
    let results = null;
    if (entry.result_file) {
      try {
        const r = await fetch(`data/${entry.result_file}`);
        if (r.ok) results = (await r.json()).results ?? null;
      } catch (_) {}
    }
    gallery.appendChild(makeCard(entry, results, type));
  }
}

async function main() {
  const loadEl    = document.getElementById('loading');
  const errorEl   = document.getElementById('error');
  const contentEl = document.getElementById('content');

  try {
    const [images, pdfs] = await Promise.all([
      loadManifest('data/images.json'),
      loadManifest('data/pdfs.json'),
    ]);

    loadEl.style.display = 'none';
    contentEl.style.display = 'block';

    if (images.length === 0 && pdfs.length === 0) {
      contentEl.innerHTML = '<p class="empty-section">No entries in any manifest yet.</p>';
      return;
    }

    // Render each section â€” easy to add mp3s.json, etc. later
    await renderSection(contentEl, 'Images',    'IMG', images, 'image');
    await renderSection(contentEl, 'Documents', 'PDF', pdfs,   'pdf');
    // Future: await renderSection(contentEl, 'Oral Histories', 'MP3', audio, 'audio');

  } catch (e) {
    loadEl.style.display = 'none';
    errorEl.style.display = 'block';
    errorEl.textContent = 'Could not load manifests: ' + e.message;
  }
}

main();
</script>
</body>
</html>
